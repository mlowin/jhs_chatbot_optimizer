{% extends 'template.htm' %}

{% block h1_title %}Reports{% endblock %}

{% block content %}
<div class="modal fade" id="chat-modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chat Inspection</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table table-sm">
          <tr><th>Time</th><td id="time"></td></tr>
          <tr><th>Question</th><td id="question"></td></tr>
          <tr><th>Filters</th><td id="filters"></td></tr>
          <tr><th>Products</th><td id="articles"></td></tr>
          <tr><th>History</th><td id="history"></td></tr>
          </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="table-responsive">
    <table class="table table-striped table-sm" id="table-chats">
        <thead>
            <tr>
                <th>Time</th>
                <th>Number of Chat Messages</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>      
 
{% endblock %}

{% block javascript %}
<script type="text/javascript">
    var chats = {{chats | safe}};

    function show_chat(el){
      let chat = chats[el];
      $('#time').html(chat['time']);
      $('#question').html(chat['question']);
      $('#filters').html("<ul><li>"+chat['filters'].join("</li><li>")+"</li></ul>");
      $('#articles').html("<ul><li>"+chat['articles'].join("</li><li>")+"</li></ul>");
      let history = [];
      for(let i in chat['chats']){
        history.push(chat['chats'][i][0]+": "+chat['chats'][i][1])
      }
      $('#history').html("<ul><li>"+history.join("</li><li>")+"</li></ul>");      
      $('#chat-modal').modal('show');
    }
    
    function redraw_table(){
      $('#table-chats tbody').html('');
      for(let i in chats){
        let chat = chats[i];
        let html = '<tr><td>'+chat['time']+"</td><td>"+chat['messages']+"</td>";
        html += '<td><span data-feather="message-circle" onclick="show_chat('+i+')" style="cursor: pointer;"></span></td></tr>';
        $('#table-chats tbody').append(html);
      }
      feather.replace();
    }

    $(document).ready(function(){
      redraw_table();
    })
</script>          
{% endblock %}