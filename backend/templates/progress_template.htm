{% extends 'template.htm' %}

{% block h1_title %}LLMs{% endblock %}

{% block content %}
<style>
    
/* Card */
.loading-card {
    max-width: 1000px;
    width: 90%;
    border: 0;
    box-shadow: 0 20px 60px rgba(0,0,0,.08);
    border-radius: 18px;
    padding: 40px;
}


/* Moving stripe background */
.progress {
    height: 18px;
    border-radius: 50px;
    background-color: #e9ecef;
    overflow: hidden;
}

.progress-bar {
    background-color: #007bff;
    position: relative;
}

/* animated stripes */
.progress-bar::after {
    content: "";
    position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;
    background-image: linear-gradient(
        45deg,
        rgba(255,255,255,.25) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255,255,255,.25) 50%,
        rgba(255,255,255,.25) 75%,
        transparent 75%,
        transparent
    );
    background-size: 40px 40px;
    animation: move 1s linear infinite;
}

@keyframes move {
    from { background-position: 40px 0; }
    to { background-position: 0 0; }
}


@keyframes dots {
    0% { content: ""; }
    33% { content: "."; }
    66% { content: ".."; }
    100% { content: "..."; }
}

.subtitle {
    color: #555;
    font-size: 15px;
}

.counter {
    font-weight: 600;
    color: #007bff;
    font-size: 18px;
}

h5{
    font-size: 1em;
    color: #555;
}
</style>
<div class="loading-card text-center">


    <h4 id="taskTitle" class="mb-2">Daten werden verarbeitet</h4>
    <h5 id="taskSubTitle" class="mb-2"></h5>


    <div class="counter mb-2">
        <span id="done">...</span> von <span id="total">...</span> fertig
    </div>

    <div class="progress mb-4">
        <div id="bar" class="progress-bar" style="width:0%"></div>
    </div>

    <small class="text-muted">
        Dieser Vorgang kann einige Zeit dauern.
    </small>

</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">    
    var uid = '{{task_id}}';
    var titles = {
        "extract_columns":"Datensatz wird verarbeitet",
        "create_vectordatabase_CreateVectordatabase_post":"Vektordatenbank wird aus Datensatz erstellt",
        "extract_filters_articles":"MÃ¶gliche Filter werden aus Datensatz extrahiert",
        "merge_extracted_filters_articles":"Extrahierte Filter werden verarbeitet",
        "apply_filters_on_products":"Extrahierte Filter werden auf Produkte angewendet",
        "create_persona":"Persona werden erstellt",
        "create_user_queries":"Synthetische Nutzeranfragen werden generiert",
        "apply_filters_on_user_queries":"Extrahierte Filter werden auf synthetische Nutzeranfragen angewendet",
        "fine_tune_model_FineTuneModel_post":"Fine-Tuning des Extraktionsmodells"
    };

    function find_title(title){
        for(let compare_title in titles){
            if(title.substr(0,compare_title.length) == compare_title){
                return titles[compare_title];
            }
        }
        return title;
    }

    function updateProgress(done, total, title) {

        if(title){
            let main_title = find_title(title);
            $("#taskTitle").text(main_title);
            $("#taskSubTitle").text(title);
        }

        $("#done").text(done);
        $("#total").text(total);

        let percent = Math.floor((done/total)*100);
        $("#bar").css("width", percent + "%");
    }

    function refresh_status(){      
        $.get("/llm_status/?uid="+uid, function(data, status){
            console.log(data);
            let obj = JSON.parse(data);
            updateProgress(obj[0],obj[1],uid);
            if(obj.length == 2){
                $('#current').html(obj[0]);
                $('#total').html(obj[1]);
            }
            else if(obj.length == 2){
                $('#current').html("running");

            }
            else{
                window.setTimeout(function(){
                    window.location.href = "/integrations/?";
                },500);
            }
        }
        );        
    }

    $(document).ready(function(){        
        refresh_status();
        window.setInterval(refresh_status,3000);     
    })
</script>          
{% endblock %}