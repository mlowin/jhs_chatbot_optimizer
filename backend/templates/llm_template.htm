{% extends 'template.htm' %}

{% block h1_title %}LLMs{% endblock %}

{% block content %}
<div class="modal fade" id="llm-modal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">LLM Config</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
            <div class="form-group row">
                <label for="model_title" class="col-sm-2 col-form-label">Title</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="model_title" value="">
                </div>
            </div>
            <div class="form-group row">
                <label for="model_name" class="col-sm-2 col-form-label">Model Name</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="model_name" value="">
                </div>
            </div>
            <div class="form-group row">
                <label for="base_url" class="col-sm-2 col-form-label">Base URL</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="base_url" value="">
                </div>
            </div>
            <div class="form-group row">
                <label for="model_token" class="col-sm-2 col-form-label">Model Token</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="model_token" value="">
                </div>
            </div>
            
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="save_llm()">Save changes</button>
      </div>
    </div>
  </div>
</div>
<div class="table-responsive">
    <table class="table table-striped table-sm" id="table-llm">
        <thead>
            <tr>
                <th>LLM-Name</th>
                <th>Type</th>
                <th>Model</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>      
<input type="button" class="btn btn-primary" onclick="add_llm()" value="Add LLM" />
<table id="llm_status">

</table>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
    var open_llm = null;
    var llm_config = {{llm_config | safe}};
    var llm_stack = {{llm_stack | safe}};
    function add_llm(){
      open_llm = null;
      $('#llm-modal').modal('show');
    }
    function edit_llm(el){
      let llm = llm_config[el];
      $('#model_title').val(llm['model_title']);
      $('#model_name').val(llm['model_name']);
      $('#base_url').val(llm['base_url']);
      $('#model_token').val(llm['model_token']);
      open_llm = el;
      $('#llm-modal').modal('show');
    }
    function save_llm(){
      let llm_item = {
        "model_title": $('#model_title').val(),
        "model_name": $('#model_name').val(),
        "base_url": $('#base_url').val(),
        "model_token": $('#model_token').val()
      }
      if(open_llm == null){ // add
        llm_config.push(llm_item);
      }
      else{ // edit
        llm_config[open_llm] = llm_item;
      }
      redraw_table();
      save_config();
      $('#llm-modal').modal('hide');
      $('#model_title').val("");
      $('#model_name').val("");
      $('#base_url').val("");
      $('#model_token').val("");

    }

    function redraw_table(){
      $('#table-llm tbody').html('');
      for(let i in llm_config){
        let llm = llm_config[i];
        let llm_html = '<tr><td>'+llm['model_title']+"</td><td>External</td><td>"+llm['model_name']+"</td>";
        llm_html += '<td><span data-feather="edit-2" onclick="edit_llm('+i+')" style="cursor: pointer;"></span></td></tr>';
        $('#table-llm tbody').append(llm_html);
      }
      feather.replace();
    }

    function save_config(){
      $.ajax({
        type: "POST",
        url: "/llms",
        data: JSON.stringify(llm_config),
        success: function(){},
        dataType: "json",
        contentType: "application/json; charset=utf-8"
      });
    }

    function refresh_status(){
      for(let i in llm_stack){
        (function(_uid){
          $.get("/llm_status/?uid="+_uid, function(data, status){
                let obj = JSON.parse(data);
                if(obj.length == 2){
                    $('#'+_uid+'_current').html(obj[0]);
                    $('#'+_uid+'_total').html(obj[1]);
                }
                else{
                  $('tr.'+_uid).remove();
                }
            }
          );
        })(llm_stack[i]['uid']);
      }
    }

    $(document).ready(function(){
      redraw_table();
      for(let i in llm_stack){
        let html = '<tr class="'+llm_stack[i]['uid']+'"><th style="width: 250px; height: 50px">'+llm_stack[i]['uid']+'</td><td><span id="'+llm_stack[i]['uid']+'_current">'+llm_stack[i]['current_item']+'</span> / <span id="'+llm_stack[i]['uid']+'_total">'+llm_stack[i]['item_size']+'</span></td></tr>';
        $('#llm_status').append(html);
      }
      if(llm_stack.length > 0){
        window.setInterval(refresh_status,3000);
      }
    })
</script>          
{% endblock %}